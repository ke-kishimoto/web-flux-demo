<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>Reactive System Demo</title>
</head>

<body>
  <div id="app">
    <h1>SSE Demo</h1>
    <div class="btn-area">
      <button @click="callStream">
        click
      </button>
    </div>
    <div id="log">
      <div>{{ message }}</div>
    </div>
  </div>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    const { createApp, ref } = Vue;
    createApp({
      setup() {
        const message = ref('');
        const customers = ref([]);

        function* parseSSE(chunkText, buffer) {
          buffer.push(chunkText);
          const joined = buffer.join('');
          const events = joined.split(/\r?\n\r?\n/);
          buffer.length = 0;

          const last = events.pop();
          if (last !== undefined) buffer.push(last);

          for (const ev of events) {
            for (const line of ev.split(/\r?\n/)) {
              if (line.startsWith("data:")) {
                yield line.slice(5);
              }
            }
          }
        }

        async function callStream() {
          message.value = '';

          try {
            const response = await fetch('/demo/sse', {
              headers: { 'Accept': 'text/event-stream' }
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            const leftoverBuf = [];

            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              const chunkText = decoder.decode(value, { stream: true });

              for (const msg of parseSSE(chunkText, leftoverBuf)) {
                message.value += msg;
              }
            }
          } catch (err) {
            message.value = `エラー: ${err.message || err}`;
          }
        }

        return {
          message,
          callStream
        };
      }
    }).mount('#app');
  </script>
</body>

</html>